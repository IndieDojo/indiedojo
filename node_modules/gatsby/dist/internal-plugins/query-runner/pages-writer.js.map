{"version":3,"sources":["../../../src/internal-plugins/query-runner/pages-writer.js"],"names":["_","require","glob","fs","store","emitter","writePages","writtenOnce","getState","program","config","pages","pagesData","reduce","mem","path","matchPath","componentChunkName","layout","jsonName","components","layouts","json","forEach","push","p","component","defaultLayoutExists","sync","directory","length","uniq","uniqBy","c","writeFile","syncRequires","map","join","j","componentName","l","asyncRequires","exports","oldPages","debouncedWritePages","debounce","isEqual","on"],"mappings":"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","file":"pages-writer.js","sourcesContent":["const _ = require(`lodash`)\nconst glob = require(`glob`)\nconst fs = require(`fs-extra`)\n\nconst { store, emitter } = require(`../../redux/`)\nimport {\n  layoutComponentChunkName,\n  pathChunkName,\n} from \"../../utils/js-chunk-names\"\n\nimport { joinPath } from \"../../utils/path\"\n\n// Write out pages information.\nconst writePages = async () => {\n  writtenOnce = true\n  const { program, config, pages } = store.getState()\n\n  // Write out pages.json\n  const pagesData = pages.reduce(\n    (mem, { path, matchPath, componentChunkName, layout, jsonName }) => [\n      ...mem,\n      { componentChunkName, layout, jsonName, path, matchPath },\n    ],\n    []\n  )\n\n  // Get list of components, layouts, and json files.\n  let components = []\n  let layouts = []\n  let json = []\n\n  pages.forEach(p => {\n    components.push({\n      componentChunkName: p.componentChunkName,\n      component: p.component,\n    })\n    if (p.layout) {\n      layouts.push(p.layout)\n    }\n    json.push({ path: p.path, jsonName: p.jsonName })\n  })\n\n  // Add the default layout if it exists.\n  let defaultLayoutExists = false\n  if (\n    glob.sync(joinPath(program.directory, `src/layouts/index.*`)).length !== 0\n  ) {\n    layouts.push(`index`)\n    defaultLayoutExists = true\n  }\n\n  layouts = _.uniq(layouts)\n  components = _.uniqBy(components, c => c.componentChunkName)\n\n  await fs.writeFile(\n    joinPath(program.directory, `.cache/pages.json`),\n    JSON.stringify(pagesData, null, 4)\n  )\n\n  // Create file with sync requires of layouts/components/json files.\n  let syncRequires = `// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n\\n`\n  syncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": preferDefault(require(\"${joinPath(\n          c.component\n        )}\"))`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n  syncRequires += `exports.json = {\\n${json\n    .map(\n      j =>\n        `  \"${j.jsonName}\": require(\"${joinPath(\n          program.directory,\n          `/.cache/json/`,\n          j.jsonName\n        )}\")`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n  syncRequires += `exports.layouts = {\\n${layouts\n    .map(l => {\n      let componentName = l\n      if (l !== false || typeof l !== `undefined`) {\n        componentName = `index`\n        return `  \"${l}\": preferDefault(require(\"${joinPath(\n          program.directory,\n          `/src/layouts/`,\n          componentName\n        )}\"))`\n      } else {\n        return `  \"${l}\": false`\n      }\n    })\n    .join(`,\\n`)}\n}`\n\n  await fs.writeFile(\n    `${program.directory}/.cache/sync-requires.js`,\n    syncRequires\n  )\n  // Create file with async requires of layouts/components/json files.\n  let asyncRequires = `// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n`\n  asyncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": require(\"gatsby-module-loader?name=${c.componentChunkName}!${joinPath(\n          c.component\n        )}\")`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n  asyncRequires += `exports.json = {\\n${json\n    .map(\n      j =>\n        `  \"${j.jsonName}\": require(\"gatsby-module-loader?name=${pathChunkName(\n          j.path\n        )}!${joinPath(program.directory, `/.cache/json/`, j.jsonName)}\")`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n  asyncRequires += `exports.layouts = {\\n${layouts\n    .map(layout => {\n      let componentName = layout\n      if (layout !== false || typeof layout !== `undefined`) {\n        componentName = `index`\n        return `  \"${layout}\": require(\"gatsby-module-loader?name=${`layout-component---${layout}`}!${joinPath(\n          program.directory,\n          `/src/layouts/`,\n          componentName\n        )}\")`\n      } else {\n        return `  \"${layout}\": false`\n      }\n    })\n    .join(`,\\n`)}\n}`\n\n  await fs.writeFile(\n    joinPath(program.directory, `.cache/async-requires.js`),\n    asyncRequires\n  )\n\n  return\n}\n\nexports.writePages = writePages\n\nlet writtenOnce = false\nlet oldPages\nconst debouncedWritePages = _.debounce(() => {\n  if (!writtenOnce || !_.isEqual(oldPages, store.getState().pages)) {\n    writePages()\n    oldPages = store.getState().pages\n  }\n}, 250)\n\nemitter.on(`CREATE_PAGE`, () => {\n  debouncedWritePages()\n})\nemitter.on(`DELETE_PAGE_BY_PATH`, () => {\n  debouncedWritePages()\n})\n"]}